// ... (Toda la parte de arriba del HTML y FirebaseConfig se mantiene igual) ...

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        // Sonido de "click" mejorado
        function playTick() {
            const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
            o.type = 'sine'; o.frequency.setValueAtTime(600, audioCtx.currentTime);
            g.gain.setValueAtTime(0.1, audioCtx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
            o.connect(g); g.connect(audioCtx.destination);
            o.start(); o.stop(audioCtx.currentTime + 0.1);
        }

        // FunciÃ³n de voz
        function hablar(texto) {
            window.speechSynthesis.cancel();
            const mensaje = new SpeechSynthesisUtterance(texto);
            mensaje.lang = 'es-ES';
            window.speechSynthesis.speak(mensaje);
        }

        // ESCUCHAR CAMBIOS DE FIREBASE
        db.ref('ruleta').on('value', (snapshot) => {
            const data = snapshot.val();
            if (data && data.premios) {
                premios = data.premios;
                if (data.estado !== 'girando') {
                    anguloActual = data.anguloFinal || 0;
                    dibujar(anguloActual);
                }
                if (data.estado === 'girando' && data.trigger !== window.lastTrigger) {
                    window.lastTrigger = data.trigger;
                    // IMPORTANTE: El navegador bloquea audio si no hay interacciÃ³n. 
                    // Al recibir la seÃ±al, intentamos activar el contexto de audio.
                    if (audioCtx.state === 'suspended') audioCtx.resume();
                    ejecutarGiroVistoPorTodos(data.fuerza, data.timestamp);
                }
            }
        });

        function ejecutarGiroVistoPorTodos(fuerza, inicioTiempo) {
            const duracion = 5000;
            const btn = document.getElementById('spinBtn');
            btn.disabled = true;
            let ultimoTick = -1;

            function animar() {
                let progreso = (Date.now() - inicioTiempo) / duracion;
                if (progreso > 1) progreso = 1;
                
                const suavizado = 1 - Math.pow(1 - progreso, 4);
                const angTotal = anguloActual + fuerza * suavizado;
                dibujar(angTotal);

                // ACTIVAR SONIDO DE TICK
                const n = premios.length;
                const ind = Math.floor((angTotal % (2 * Math.PI)) / ((2 * Math.PI)/n));
                if (ind !== ultimoTick) { 
                    playTick(); 
                    ultimoTick = ind; 
                }

                if (progreso < 1) { 
                    requestAnimationFrame(animar); 
                } else {
                    const anguloFinal = angTotal % (2 * Math.PI);
                    btn.disabled = false;
                    const finalIdx = Math.floor((2 * Math.PI - (anguloFinal % (2 * Math.PI)) + (1.5 * Math.PI)) % (2 * Math.PI) / ((2 * Math.PI)/n));
                    const ganador = premios[finalIdx];
                    
                    document.getElementById('resultado').innerText = "ðŸŽ‰ Â¡GANADOR: " + ganador + "!";
                    
                    // ACTIVAR VOZ
                    hablar("Â¡Felicidades! El ganador es " + ganador);
                    
                    if (document.getElementById('adminPanel')) {
                        db.ref('ruleta').update({ estado: 'parado', anguloFinal: anguloFinal });
                    }
                }
            }
            animar();
        }
